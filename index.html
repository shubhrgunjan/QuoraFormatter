<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quora Post Formatter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            cursor: grab;
            transition: box-shadow 0.2s ease-in-out;
        }
        .card:active {
            cursor: grabbing;
            box-shadow: 0 0 0 2px #4f46e5;
        }
        .dragging {
            opacity: 0.5;
        }
        .drop-zone {
            border: 2px dashed #d1d5db;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .drop-zone.dragover {
            background-color: #eef2ff;
            border-color: #4f46e5;
        }
        #output-editor {
            background-color: #f9fafb;
            min-height: 400px;
        }
        .ql-editor {
            font-size: 16px;
            line-height: 1.6;
        }
        .ql-editor img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 8px 0;
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .filter-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .filter-btn:not(.active) {
            background-color: #e5e7eb;
            color: #374151;
        }
        .used-toggle-btn {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Quora Content Formatter</h1>
            <p class="text-gray-600 mt-2">A new, improved workflow to build your posts.(v1.1)</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Input, Gallery, and Staging -->
            <div>
                <!-- Step 1: Add Content -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h2 class="text-2xl font-semibold mb-4">1. Add Content</h2>
                    <div class="space-y-4">
                        <!-- Reddit Fetcher -->
                        <details class="group">
                            <summary class="cursor-pointer font-semibold text-indigo-700">Fetch from Reddit</summary>
                            <div class="mt-4 space-y-4 border-t pt-4">
                                <div>
                                    <label for="scraperApiKey" class="block text-sm font-medium text-gray-700">Your ScraperAPI Key (<a href="https://scraperapi.com" target="_blank" class="text-indigo-600 hover:underline">Get a free key</a>)</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="password" id="scraperApiKey" placeholder="Enter your ScraperAPI key here" class="flex-grow block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <button id="saveApiBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors">Save</button>
                                    </div>
                                    <p id="api-key-status" class="text-xs text-green-600 mt-1 font-semibold hidden"></p>
                                </div>
                                <div>
                                    <label for="redditUrl" class="block text-sm font-medium text-gray-700">Reddit Post URL (or Drag & Drop Link)</label>
                                    <input type="url" id="redditUrl" placeholder="https://www.reddit.com/r/..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <p id="reddit-fetch-status" class="text-xs text-indigo-500 mt-1 font-semibold hidden"></p>
                                </div>
                                <button id="fetchRedditBtn" class="w-full bg-orange-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors">Fetch & Add to Library</button>
                            </div>
                        </details>
                        <!-- Manual Input -->
                        <details class="group" open>
                             <summary class="cursor-pointer font-semibold text-indigo-700">Add Manually</summary>
                             <div class="mt-4 space-y-4 border-t pt-4">
                                <div id="manual-drop-zone" class="drop-zone p-4 rounded-lg">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Image URLs (Drag & Drop images here)</label>
                                    <div id="manual-image-inputs" class="space-y-2">
                                        <!-- Dynamic inputs will be added here -->
                                    </div>
                                    <p id="upload-status" class="text-xs text-indigo-500 mt-1 font-semibold hidden"></p>
                                </div>
                                <button type="button" id="add-image-input-btn" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold">+ Add another image URL</button>
                                
                                <div>
                                    <label for="caption" class="block text-sm font-medium text-gray-700">Caption</label>
                                    <textarea id="caption" rows="3" placeholder="A descriptive caption for the image(s)..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                </div>
                                <div>
                                    <label for="sourceUrl" class="block text-sm font-medium text-gray-700">Source Link (Optional)</label>
                                    <input type="url" id="sourceUrl" placeholder="https://example.com/source-article" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <button id="addItemBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">Add Item to Library</button>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Step 2: Your Content Library -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <h2 class="text-2xl font-semibold">2. Your Content Library</h2>
                        <div class="flex items-center gap-2">
                            <button id="exportBtn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded-md transition-colors">Export</button>
                            <label for="importFile" class="cursor-pointer text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded-md transition-colors">Import<input type="file" id="importFile" class="hidden" accept=".json"></label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <div id="filter-container" class="flex gap-2">
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="unused">Unused</button>
                            <button class="filter-btn" data-filter="used">Used</button>
                        </div>
                        <select id="date-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                    </div>
                    <div id="gallery" class="space-y-4 min-h-[150px] max-h-[50vh] overflow-y-auto p-2 bg-gray-50 rounded-lg">
                        <p id="gallery-placeholder" class="text-center text-gray-400 p-4">Your content will appear here.</p>
                    </div>
                    <button id="stageSelectedBtn" class="mt-4 w-full bg-teal-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-teal-700 transition-colors">Add Selected to Post</button>
                </div>

                <!-- Step 3: Arrange Your Post -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">3. Arrange Your Post</h2>
                        <button id="clearStagingBtn" class="text-sm bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-1 px-3 rounded-md transition-colors">Clear All</button>
                    </div>
                    <div id="staging-area" class="space-y-4 min-h-[150px] p-2 bg-teal-50 rounded-lg">
                        <p id="staging-placeholder" class="text-center text-gray-500 p-4">Items added to your post will appear here. Drag them to reorder.</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Output -->
            <div class="sticky top-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">4. Generate & Copy</h2>
                    <button id="generateBtn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors mb-4">Generate Post & Mark as Used</button>
                    <div class="relative mb-6">
                        <h3 class="font-semibold text-lg mb-2">Post Content</h3>
                        <div id="output-editor"></div>
                        <button id="copyBtn" class="absolute top-10 right-2 bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-2 rounded hover:bg-gray-300 z-10">Copy Post</button>
                    </div>
                    <div id="sources-container" class="relative hidden">
                        <h3 class="font-semibold text-lg mb-2">Sources</h3>
                        <textarea id="sources-output" rows="5" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-md" readonly></textarea>
                        <button id="copySourcesBtn" class="absolute top-10 right-2 bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-2 rounded hover:bg-gray-300 z-10">Copy Sources</button>
                    </div>
                    <div id="copy-feedback" class="text-sm text-green-600 mt-2 text-center font-medium hidden">Copied to clipboard!</div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="error-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-bold text-red-600 mb-4">An Error Occurred</h3>
            <p id="error-modal-message" class="text-gray-700 mb-4"></p>
            <button id="error-modal-close" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700">Close</button>
        </div>
    </div>
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50 overflow-y-auto p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full space-y-4">
            <h3 class="text-lg font-bold text-gray-900">Edit Content</h3>
            <input type="hidden" id="edit-item-id">
            <div>
                <label class="block text-sm font-medium text-gray-700">Image URLs</label>
                <div id="edit-image-inputs" class="space-y-2"></div>
                <button type="button" id="edit-add-image-btn" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-semibold">+ Add another image URL</button>
            </div>
            <div>
                <label for="edit-caption" class="block text-sm font-medium text-gray-700">Caption</label>
                <textarea id="edit-caption" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div>
                <label for="edit-sourceUrl" class="block text-sm font-medium text-gray-700">Source Link</label>
                <input type="url" id="edit-sourceUrl" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="flex justify-end gap-4">
                <button id="edit-modal-cancel" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="edit-modal-save" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Save Changes</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const gallery = document.getElementById('gallery');
            const galleryPlaceholder = document.getElementById('gallery-placeholder');
            const stagingArea = document.getElementById('staging-area');
            const stagingPlaceholder = document.getElementById('staging-placeholder');
            const addItemBtn = document.getElementById('addItemBtn');
            const generateBtn = document.getElementById('generateBtn');
            const copyBtn = document.getElementById('copyBtn');
            const copySourcesBtn = document.getElementById('copySourcesBtn');
            const copyFeedback = document.getElementById('copy-feedback');
            const sourcesContainer = document.getElementById('sources-container');
            const sourcesOutput = document.getElementById('sources-output');
            
            // Input Form
            const manualImageInputsContainer = document.getElementById('manual-image-inputs');
            const addImageInputBtn = document.getElementById('add-image-input-btn');
            const captionInput = document.getElementById('caption');
            const sourceUrlInput = document.getElementById('sourceUrl');
            const manualDropZone = document.getElementById('manual-drop-zone');
            const uploadStatus = document.getElementById('upload-status');
            
            // Reddit Fetcher
            const redditUrlInput = document.getElementById('redditUrl');
            const fetchRedditBtn = document.getElementById('fetchRedditBtn');
            const redditFetchStatus = document.getElementById('reddit-fetch-status');
            const scraperApiKeyInput = document.getElementById('scraperApiKey');
            const saveApiBtn = document.getElementById('saveApiBtn');
            const apiKeyStatus = document.getElementById('api-key-status');

            // Filters & Actions
            const filterContainer = document.getElementById('filter-container');
            const dateFilter = document.getElementById('date-filter');
            const stageSelectedBtn = document.getElementById('stageSelectedBtn');
            const clearStagingBtn = document.getElementById('clearStagingBtn');
            
            // Modals
            const errorModal = document.getElementById('error-modal');
            const errorModalMessage = document.getElementById('error-modal-message');
            const errorModalClose = document.getElementById('error-modal-close');
            const editModal = document.getElementById('edit-modal');
            const editItemId = document.getElementById('edit-item-id');
            const editImageInputsContainer = document.getElementById('edit-image-inputs');
            const editAddImageBtn = document.getElementById('edit-add-image-btn');
            const editCaption = document.getElementById('edit-caption');
            const editSourceUrl = document.getElementById('edit-sourceUrl');
            const editModalCancel = document.getElementById('edit-modal-cancel');
            const editModalSave = document.getElementById('edit-modal-save');

            // Export/Import
            const exportBtn = document.getElementById('exportBtn');
            const importFile = document.getElementById('importFile');

            // --- Data Store ---
            let contentItems = [];
            let stagedItems = [];
            let itemIdCounter = 0;
            let currentFilter = 'all';
            let currentSort = 'newest';

            // --- Initialize Quill Editor ---
            const quill = new Quill('#output-editor', {
                theme: 'snow',
                modules: { toolbar: false },
                placeholder: 'Your formatted post will appear here...'
            });

            // --- API Key for ImgBB ---
            const IMGBB_API_KEY = '1663bd194a8fb9274308b4c12d2c4b33';

            // --- Utility Functions ---
            function showErrorModal(message) {
                errorModalMessage.textContent = message;
                errorModal.classList.remove('hidden');
            }
            errorModalClose.addEventListener('click', () => errorModal.classList.add('hidden'));

            const isLocalStorageAvailable = (() => {
                try {
                    const test = '__storage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            })();

            // --- Local Storage Functions ---
            function saveToLocalStorage() {
                if (!isLocalStorageAvailable) return;
                try {
                    const data = {
                        items: contentItems,
                        counter: itemIdCounter,
                        scraperApiKey: scraperApiKeyInput.value
                    };
                    localStorage.setItem('quoraFormatterData', JSON.stringify(data));
                } catch (error) {
                    console.error("Error saving to local storage:", error);
                    showErrorModal("Could not save data. Your changes may not persist.");
                }
            }

            function loadFromLocalStorage() {
                if (!isLocalStorageAvailable) {
                    console.warn("Local storage is not available. Starting fresh.");
                    return;
                }
                try {
                    const data = localStorage.getItem('quoraFormatterData');
                    if (data) {
                        const parsedData = JSON.parse(data);
                        if (parsedData && typeof parsedData === 'object') {
                            contentItems = Array.isArray(parsedData.items) ? parsedData.items : [];
                            contentItems.forEach(item => {
                                if (item.imageUrl && !item.imageUrls) {
                                    item.imageUrls = [item.imageUrl];
                                    delete item.imageUrl;
                                }
                            });
                            itemIdCounter = typeof parsedData.counter === 'number' ? parsedData.counter : 0;
                            scraperApiKeyInput.value = typeof parsedData.scraperApiKey === 'string' ? parsedData.scraperApiKey : '';
                        }
                    }
                } catch (error) {
                    console.error("Error loading data from local storage:", error);
                    showErrorModal("Could not load previous data as it appears to be corrupted. Starting a new session.");
                    localStorage.removeItem('quoraFormatterData');
                }
                renderGallery();
                renderStagingArea();
            }

            // --- Rendering Functions ---
            function renderGallery() {
                gallery.innerHTML = '';
                let itemsToRender = contentItems.filter(item => {
                    if (currentFilter === 'used') return item.used;
                    if (currentFilter === 'unused') return !item.used;
                    return true;
                });

                itemsToRender.sort((a, b) => {
                    const dateA = a.createdAt || 0;
                    const dateB = b.createdAt || 0;
                    return currentSort === 'newest' ? dateB - dateA : dateA - dateB;
                });

                if (itemsToRender.length === 0) {
                    gallery.appendChild(galleryPlaceholder);
                } else {
                    itemsToRender.forEach(item => gallery.appendChild(createItemCard(item)));
                }
            }
            
            function renderStagingArea() {
                stagingArea.innerHTML = '';
                if (stagedItems.length === 0) {
                    stagingArea.appendChild(stagingPlaceholder);
                } else {
                    stagedItems.forEach(item => stagingArea.appendChild(createStagedItemCard(item)));
                }
            }

            // --- Card Creation ---
            function createItemCard(item) {
                const card = document.createElement('div');
                card.className = 'card bg-gray-50 p-3 rounded-lg shadow-sm flex items-start gap-3 border';
                card.dataset.id = item.id;
                const usedTagHTML = item.used ? `<span class="used-toggle-btn text-xs font-bold py-1 px-2 rounded-full bg-green-200 text-green-800">USED</span>` : `<span class="used-toggle-btn text-xs font-bold py-1 px-2 rounded-full bg-gray-200 text-gray-700">UNUSED</span>`;
                const multiImageTag = item.imageUrls.length > 1 ? `<span class="text-xs font-bold py-1 px-2 rounded-full bg-blue-200 text-blue-800">+${item.imageUrls.length - 1} more</span>` : '';
                
                card.innerHTML = `
                    <input type="checkbox" class="mt-1 h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 flex-shrink-0" ${item.selected ? 'checked' : ''}>
                    <img src="${item.imageUrls[0]}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/e2e8f0/94a3b8?text=No+Img';" class="w-20 h-20 object-cover rounded-md flex-shrink-0">
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800 break-words">${item.caption}</p>
                        <div class="flex items-center mt-2 flex-wrap gap-2">
                             <p class="text-xs text-gray-500">Added: ${new Date(item.createdAt).toLocaleDateString()}</p>
                             ${usedTagHTML}
                             ${multiImageTag}
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 flex-shrink-0">
                        <button class="edit-btn text-blue-500 hover:text-blue-700 font-bold text-lg" title="Edit">‚úèÔ∏è</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-bold text-lg" title="Delete">üóëÔ∏è</button>
                    </div>
                `;
                card.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                    const itemToUpdate = contentItems.find(i => i.id == item.id);
                    if (itemToUpdate) itemToUpdate.selected = e.target.checked;
                });
                card.querySelector('.delete-btn').addEventListener('click', () => {
                    if (confirm('Are you sure you want to permanently delete this item?')) {
                        contentItems = contentItems.filter(i => i.id !== item.id);
                        saveToLocalStorage();
                        renderGallery();
                    }
                });
                card.querySelector('.edit-btn').addEventListener('click', () => showEditModal(item));
                card.querySelector('.used-toggle-btn').addEventListener('click', () => {
                     const itemToUpdate = contentItems.find(i => i.id == item.id);
                     if(itemToUpdate) {
                         itemToUpdate.used = !itemToUpdate.used;
                         saveToLocalStorage();
                         renderGallery();
                     }
                });
                return card;
            }
            
            function createStagedItemCard(item) {
                const card = document.createElement('div');
                card.className = 'card bg-white p-3 rounded-lg shadow-sm flex items-center gap-3 border border-teal-500';
                card.setAttribute('draggable', true);
                card.dataset.id = item.id;
                 card.innerHTML = `
                    <span class="cursor-grab text-gray-400" title="Drag to reorder">‚ò∞</span>
                    <img src="${item.imageUrls[0]}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/e2e8f0/94a3b8?text=X';" class="w-10 h-10 object-cover rounded-md flex-shrink-0">
                    <p class="flex-grow font-medium text-gray-800 break-words truncate">${item.caption}</p>
                    <button class="remove-staged-btn text-red-500 hover:text-red-700 font-bold text-lg flex-shrink-0" title="Remove from post">&times;</button>
                `;
                card.querySelector('.remove-staged-btn').addEventListener('click', () => {
                    stagedItems = stagedItems.filter(i => i.id !== item.id);
                    renderStagingArea();
                });
                return card;
            }

            // --- Main Actions ---
            function handleAddItem(data) {
                if (!data.imageUrls || data.imageUrls.length === 0) {
                    showErrorModal("An item must have at least one image URL.");
                    return;
                }
                contentItems.push({ 
                    id: itemIdCounter++, 
                    imageUrls: data.imageUrls, 
                    caption: data.caption, 
                    sourceUrl: data.sourceUrl, 
                    selected: false,
                    used: false,
                    createdAt: Date.now()
                });
                saveToLocalStorage();
                renderGallery();
                captionInput.value = sourceUrlInput.value = '';
                manualImageInputsContainer.innerHTML = '';
                createImageInput();
            }

            function handleGenerate() {
                if (stagedItems.length === 0) {
                    showErrorModal('Your post is empty. Add items from your library to the "Arrange Your Post" area first.');
                    return;
                }
                quill.setContents([]);
                let sourcesToDisplay = [];
                stagedItems.forEach((item, index) => {
                    quill.insertText(quill.getLength() - 1, `${index + 1}. ${item.caption}\n`);
                    item.imageUrls.forEach(url => {
                        quill.insertEmbed(quill.getLength() - 1, 'image', url);
                        quill.insertText(quill.getLength() - 1, '\n');
                    });
                    quill.insertText(quill.getLength() - 1, '-\n');
                    if (item.sourceUrl) sourcesToDisplay.push(item.sourceUrl);
                    const originalItem = contentItems.find(ci => ci.id === item.id);
                    if (originalItem) originalItem.used = true;
                });
                sourcesOutput.value = sourcesToDisplay.length > 0 ? "Sources:\n" + sourcesToDisplay.map((url, i) => `${i + 1}. ${url}`).join('\n') : '';
                sourcesContainer.style.display = sourcesToDisplay.length > 0 ? 'block' : 'none';
                saveToLocalStorage();
                renderGallery();
            }

            function handleCopy(element, feedbackText) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                
                if (typeof element === 'string') {
                    const editor = document.querySelector(element);
                    const range = document.createRange();
                    range.selectNodeContents(editor);
                    selection.addRange(range);
                } else {
                    element.select();
                }
                
                try {
                    if (!document.execCommand('copy')) throw new Error('Copy command failed');
                    copyFeedback.textContent = feedbackText;
                    copyFeedback.classList.remove('hidden');
                    setTimeout(() => copyFeedback.classList.add('hidden'), 2500);
                } catch (err) {
                    console.error('Copy failed', err);
                    showErrorModal('Could not copy the content.');
                }
                selection.removeAllRanges();
            }

            // --- Staging Area Logic ---
            stageSelectedBtn.addEventListener('click', () => {
                const selectedItems = contentItems.filter(item => item.selected);
                if (selectedItems.length === 0) {
                    showErrorModal('Please select items from the library using the checkboxes.');
                    return;
                }
                selectedItems.forEach(item => {
                    if (!stagedItems.some(si => si.id === item.id)) {
                        stagedItems.push({ ...item });
                    }
                    item.selected = false;
                });
                renderStagingArea();
                renderGallery();
            });

            clearStagingBtn.addEventListener('click', () => {
                stagedItems = [];
                renderStagingArea();
            });

            // --- Dynamic Image Inputs ---
            function createImageInput(value = '') {
                const container = document.createElement('div');
                container.className = 'flex items-center gap-2 mt-1';
                container.innerHTML = `
                    <input type="url" name="imageUrl" placeholder="https://example.com/image.jpg" value="${value}" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button type="button" class="remove-image-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
                `;
                container.querySelector('.remove-image-btn').addEventListener('click', (e) => {
                    if (e.currentTarget.parentElement.parentElement.childElementCount > 1) {
                        e.currentTarget.parentElement.remove();
                    } else {
                        e.currentTarget.previousElementSibling.value = '';
                    }
                });
                return container;
            }
            addImageInputBtn.addEventListener('click', () => {
                manualImageInputsContainer.appendChild(createImageInput());
            });

            // --- Edit Modal Logic ---
            function showEditModal(item) {
                editItemId.value = item.id;
                editImageInputsContainer.innerHTML = '';
                item.imageUrls.forEach(url => {
                    editImageInputsContainer.appendChild(createImageInput(url));
                });
                editCaption.value = item.caption;
                editSourceUrl.value = item.sourceUrl;
                editModal.classList.remove('hidden');
            }
            editAddImageBtn.addEventListener('click', () => {
                editImageInputsContainer.appendChild(createImageInput());
            });

            function hideEditModal() {
                editModal.classList.add('hidden');
            }

            editModalSave.addEventListener('click', () => {
                const id = parseInt(editItemId.value);
                const itemToUpdate = contentItems.find(i => i.id === id);
                if (itemToUpdate) {
                    const imageUrls = Array.from(editImageInputsContainer.querySelectorAll('input[name="imageUrl"]'))
                                          .map(input => input.value.trim())
                                          .filter(url => url);
                    if (imageUrls.length === 0) {
                        showErrorModal("Content must have at least one image.");
                        return;
                    }
                    itemToUpdate.imageUrls = imageUrls;
                    itemToUpdate.caption = editCaption.value;
                    itemToUpdate.sourceUrl = editSourceUrl.value;
                    saveToLocalStorage();
                    renderGallery();
                }
                hideEditModal();
            });
            editModalCancel.addEventListener('click', hideEditModal);
            
            // --- Image Upload & Reddit Fetching ---
            async function handleImageFile(file) {
                if (!file || !file.type.startsWith('image/')) {
                    showErrorModal('Please drop or paste an image file.');
                    return;
                }
                uploadStatus.textContent = 'Uploading image...';
                uploadStatus.classList.remove('hidden');
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error(`Image upload failed with status: ${response.status}`);
                    const result = await response.json();
                    if (result.success) {
                        const newUrl = result.data.url;
                        const firstEmptyInput = Array.from(manualImageInputsContainer.querySelectorAll('input[name="imageUrl"]')).find(input => !input.value);
                        if (firstEmptyInput) {
                            firstEmptyInput.value = newUrl;
                        } else {
                            manualImageInputsContainer.appendChild(createImageInput(newUrl));
                        }
                        uploadStatus.textContent = 'Upload complete!';
                    } else { throw new Error('Image hosting service returned an error.'); }
                } catch (error) {
                    console.error("Image upload error:", error);
                    showErrorModal(error.message);
                } finally {
                    setTimeout(() => uploadStatus.classList.add('hidden'), 2000);
                }
            }
            
            async function fetchRedditPost() {
                const apiKey = scraperApiKeyInput.value.trim();
                if (!apiKey) {
                    showErrorModal('Please enter your ScraperAPI key to fetch Reddit posts.');
                    return;
                }
                let url = redditUrlInput.value.trim();
                if (!url) { showErrorModal('Please enter a Reddit post URL.'); return; }
                if (url.endsWith('/')) url = url.slice(0, -1);
                if (!url.endsWith('.json')) url += '.json';
                const fetchUrl = `https://api.scraperapi.com?api_key=${apiKey}&url=${encodeURIComponent(url)}`;
                fetchRedditBtn.disabled = true;
                redditFetchStatus.textContent = 'Fetching post...';
                redditFetchStatus.classList.remove('hidden');
                try {
                    const response = await fetch(fetchUrl);
                    if (!response.ok) throw new Error(`Failed to fetch. Status: ${response.status}`);
                    const data = await response.json();
                    const postData = data[0]?.data?.children[0]?.data;
                    if (!postData) throw new Error('Could not find post data in the response.');

                    let imageUrls = [];
                    if (postData.is_gallery) {
                        const media = postData.media_metadata;
                        for (const key in media) {
                            const ext = media[key].m.split('/')[1];
                            imageUrls.push(`https://i.redd.it/${media[key].id}.${ext}`);
                        }
                    } else if (postData.post_hint === 'image') {
                        imageUrls.push(postData.url_overridden_by_dest || postData.url);
                    }
                    
                    if (imageUrls.length === 0) {
                        throw new Error('This post does not contain any direct images or galleries.');
                    }

                    handleAddItem({
                        imageUrls: imageUrls,
                        caption: postData.title,
                        sourceUrl: `https://www.reddit.com${postData.permalink}`
                    });

                    redditFetchStatus.textContent = 'Post added to library!';
                    redditUrlInput.value = '';
                    setTimeout(() => redditFetchStatus.classList.add('hidden'), 3000);
                } catch (error) {
                    console.error("Reddit fetch error:", error);
                    showErrorModal(`Fetch failed: ${error.message}`);
                    redditFetchStatus.classList.add('hidden');
                } finally {
                    fetchRedditBtn.disabled = false;
                }
            }
            
            // --- Event Listeners ---
            addItemBtn.addEventListener('click', () => {
                const imageUrls = Array.from(manualImageInputsContainer.querySelectorAll('input[name="imageUrl"]'))
                                      .map(input => input.value.trim())
                                      .filter(url => url);
                const caption = captionInput.value.trim();
                if (imageUrls.length === 0 || !caption) {
                    showErrorModal('Please provide at least one image URL and a caption.');
                    return;
                }
                handleAddItem({
                    imageUrls,
                    caption,
                    sourceUrl: sourceUrlInput.value.trim()
                });
            });

            generateBtn.addEventListener('click', handleGenerate);
            copyBtn.addEventListener('click', () => handleCopy('#output-editor .ql-editor', 'Post copied!'));
            copySourcesBtn.addEventListener('click', () => handleCopy(sourcesOutput, 'Sources copied!'));
            fetchRedditBtn.addEventListener('click', fetchRedditPost);
            saveApiBtn.addEventListener('click', () => {
                saveToLocalStorage();
                apiKeyStatus.textContent = 'API Key saved!';
                apiKeyStatus.classList.remove('hidden');
                setTimeout(() => apiKeyStatus.classList.add('hidden'), 2500);
            });
            
            filterContainer.addEventListener('click', (e) => {
                if (e.target.matches('.filter-btn')) {
                    filterContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    renderGallery();
                }
            });
            dateFilter.addEventListener('change', (e) => {
                currentSort = e.target.value;
                renderGallery();
            });

            manualDropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('dragover'); });
            manualDropZone.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('dragover'));
            manualDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    handleImageFile(e.dataTransfer.files[0]);
                }
            });

            redditUrlInput.addEventListener('drop', (e) => {
                e.preventDefault();
                const link = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain');
                if (link && link.includes('reddit.com')) {
                    redditUrlInput.value = link;
                    fetchRedditPost();
                }
            });

            function setupDragAndDrop(container, list, renderFunc) {
                 let draggedItem = null;
                 container.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('card')) {
                        draggedItem = e.target;
                        setTimeout(() => e.target.classList.add('dragging'), 0);
                    }
                 });
                 container.addEventListener('dragend', () => {
                    if (draggedItem) {
                        draggedItem.classList.remove('dragging');
                        draggedItem = null;
                        const newOrderIds = [...container.querySelectorAll('.card')].map(card => parseInt(card.dataset.id));
                        list.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
                        renderFunc();
                        if (list === contentItems) saveToLocalStorage();
                    }
                 });
                 container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = [...container.querySelectorAll('.card:not(.dragging)')].reduce((closest, child) => {
                        const box = child.getBoundingClientRect();
                        const offset = e.clientY - box.top - box.height / 2;
                        return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest;
                    }, { offset: Number.NEGATIVE_INFINITY }).element;
                    if (draggedItem) container.insertBefore(draggedItem, afterElement);
                 });
            }
            setupDragAndDrop(stagingArea, stagedItems, renderStagingArea);

            // --- Initial Load ---
            loadFromLocalStorage();
            manualImageInputsContainer.innerHTML = '';
            manualImageInputsContainer.appendChild(createImageInput());
        });
    </script>
</body>
</html>
