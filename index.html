<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quora Post Formatter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Include Quill's stylesheet -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            cursor: grab;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:active {
            cursor: grabbing;
            transform: scale(1.05);
        }
        .dragging {
            opacity: 0.5;
        }
        .drop-zone {
            border: 2px dashed #d1d5db;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .drop-zone.dragover {
            background-color: #eef2ff;
            border-color: #4f46e5;
        }
        /* Quill Editor Styling */
        #output-editor {
            background-color: #f9fafb;
            min-height: 400px;
        }
        .ql-editor {
            font-size: 16px;
            line-height: 1.6;
        }
        .ql-editor img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 8px 0;
        }
        /* Filter Styling */
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .filter-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .filter-btn:not(.active) {
            background-color: #e5e7eb;
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Quora Content Formatter</h1>
            <p class="text-gray-600 mt-2">Add content, reorder, then generate a post ready to be copied and pasted.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Input and Gallery -->
            <div>
                 <!-- Reddit Fetcher -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h2 class="text-2xl font-semibold mb-4">Fetch from Reddit</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="redditUrl" class="block text-sm font-medium text-gray-700">Reddit Post URL</label>
                            <input type="url" id="redditUrl" placeholder="https://www.reddit.com/r/..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                             <p id="reddit-fetch-status" class="text-xs text-indigo-500 mt-1 font-semibold hidden"></p>
                        </div>
                        <button id="fetchRedditBtn" class="w-full bg-orange-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Fetch Post
                        </button>
                    </div>
                </div>

                <!-- Input Form -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h2 class="text-2xl font-semibold mb-4">1. Add Content Manually</h2>
                    <div class="space-y-4">
                        <div id="dropZone" class="drop-zone p-4 rounded-md text-center">
                            <label for="imageUrl" class="block text-sm font-medium text-gray-700 mb-2">Image URL, Drag & Drop, or Paste Image</label>
                            <input type="url" id="imageUrl" placeholder="Enter URL or drop/paste an image" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                             <p id="upload-status" class="text-xs text-indigo-500 mt-1 font-semibold hidden"></p>
                        </div>
                        <div>
                            <label for="caption" class="block text-sm font-medium text-gray-700">Caption</label>
                            <textarea id="caption" rows="3" placeholder="A descriptive caption for the image..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        <div>
                            <label for="sourceUrl" class="block text-sm font-medium text-gray-700">Source Link (Optional)</label>
                            <input type="url" id="sourceUrl" placeholder="https://example.com/source-article" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button id="addItemBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Add Item to Gallery
                        </button>
                    </div>
                </div>

                <!-- Content Gallery -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                         <h2 class="text-2xl font-semibold">2. Your Content</h2>
                         <div class="flex items-center gap-4">
                            <div id="filter-container" class="flex gap-2">
                                <button class="filter-btn active" data-filter="all">All</button>
                                <button class="filter-btn" data-filter="unused">Unused</button>
                                <button class="filter-btn" data-filter="used">Used</button>
                            </div>
                             <div class="flex gap-2">
                                <button id="exportBtn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded-md transition-colors">Export</button>
                                <label for="importFile" class="cursor-pointer text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded-md transition-colors">
                                    Import
                                    <input type="file" id="importFile" class="hidden" accept=".json">
                                </label>
                             </div>
                         </div>
                    </div>
                    <div id="gallery" class="space-y-4 min-h-[100px]">
                        <p id="gallery-placeholder" class="text-center text-gray-400">Your content will appear here.</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Output -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold mb-4">3. Generate & Copy</h2>
                <button id="generateBtn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors mb-4">
                    Generate Post & Mark as Used
                </button>
                <div class="relative mb-6">
                    <h3 class="font-semibold text-lg mb-2">Post Content</h3>
                    <div id="output-editor"></div>
                    <button id="copyBtn" class="absolute top-10 right-2 bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-2 rounded hover:bg-gray-300 z-10">Copy Post</button>
                </div>
                <div id="sources-container" class="relative hidden">
                     <h3 class="font-semibold text-lg mb-2">Sources</h3>
                     <textarea id="sources-output" rows="5" class="w-full p-3 bg-gray-50 border border-gray-300 rounded-md" readonly></textarea>
                     <button id="copySourcesBtn" class="absolute top-10 right-2 bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-2 rounded hover:bg-gray-300 z-10">Copy Sources</button>
                </div>
                 <div id="copy-feedback" class="text-sm text-green-600 mt-2 text-center font-medium hidden">Copied to clipboard!</div>
            </div>
        </main>
    </div>

    <!-- Include the Quill library -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <script>
        // --- DOM Elements ---
        const imageUrlInput = document.getElementById('imageUrl');
        const captionInput = document.getElementById('caption');
        const sourceUrlInput = document.getElementById('sourceUrl');
        const addItemBtn = document.getElementById('addItemBtn');
        const gallery = document.getElementById('gallery');
        const galleryPlaceholder = document.getElementById('gallery-placeholder');
        const generateBtn = document.getElementById('generateBtn');
        const copyBtn = document.getElementById('copyBtn');
        const copyFeedback = document.getElementById('copy-feedback');
        const dropZone = document.getElementById('dropZone');
        const exportBtn = document.getElementById('exportBtn');
        const importFile = document.getElementById('importFile');
        const uploadStatus = document.getElementById('upload-status');
        const sourcesContainer = document.getElementById('sources-container');
        const sourcesOutput = document.getElementById('sources-output');
        const copySourcesBtn = document.getElementById('copySourcesBtn');
        const redditUrlInput = document.getElementById('redditUrl');
        const fetchRedditBtn = document.getElementById('fetchRedditBtn');
        const redditFetchStatus = document.getElementById('reddit-fetch-status');
        const filterContainer = document.getElementById('filter-container');

        // --- Data Store ---
        let contentItems = [];
        let itemIdCounter = 0;
        let currentFilter = 'all';

        // --- Initialize Quill Editor ---
        const quill = new Quill('#output-editor', {
            theme: 'snow',
            modules: { toolbar: false },
            placeholder: 'Your formatted post will appear here...'
        });

        // --- API Key for ImgBB ---
        const IMGBB_API_KEY = '1663bd194a8fb9274308b4c12d2c4b33';

        // --- Local Storage Functions ---
        function saveToLocalStorage() {
            const data = {
                items: contentItems,
                counter: itemIdCounter
            };
            localStorage.setItem('quoraFormatterData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem('quoraFormatterData');
            if (data) {
                const parsedData = JSON.parse(data);
                contentItems = parsedData.items || [];
                itemIdCounter = parsedData.counter || 0;
            }
            renderGallery();
        }

        // --- Core Functions (with Local Storage integration) ---
        function renderGallery() {
            gallery.innerHTML = '';
            
            const filteredItems = contentItems.filter(item => {
                if (currentFilter === 'used') return item.used;
                if (currentFilter === 'unused') return !item.used;
                return true; // 'all'
            });

            if (filteredItems.length === 0) {
                gallery.appendChild(galleryPlaceholder);
                galleryPlaceholder.textContent = "No items match the current filter.";
                galleryPlaceholder.classList.remove('hidden');
            } else {
                galleryPlaceholder.classList.add('hidden');
                filteredItems.forEach(item => gallery.appendChild(createItemCard(item)));
            }
        }

        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = 'card bg-gray-50 p-4 rounded-lg shadow-sm flex items-start gap-4 border';
            card.setAttribute('draggable', true);
            card.dataset.id = item.id;
            const sourceLinkHTML = item.sourceUrl ? `<a href="${item.sourceUrl}" target="_blank" class="text-sm text-indigo-600 hover:underline break-all">${item.sourceUrl}</a>` : `<p class="text-sm text-gray-400">No source provided</p>`;
            const dateString = item.createdAt ? new Date(item.createdAt).toLocaleDateString() : 'N/A';

            const usedTagHTML = item.used 
                ? `<span class="used-toggle-btn cursor-pointer text-xs font-bold py-1 px-2 rounded-full bg-green-500 text-white">USED</span>`
                : `<span class="used-toggle-btn cursor-pointer text-xs font-bold py-1 px-2 rounded-full bg-gray-400 text-white">UNUSED</span>`;

            card.innerHTML = `
                <input type="checkbox" class="mt-1 h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${item.selected ? 'checked' : ''}>
                <img src="${item.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/94a3b8?text=No+Image';" class="w-20 h-20 object-cover rounded-md flex-shrink-0">
                <div class="flex-grow">
                    <p class="font-semibold text-gray-800 break-words">${item.caption}</p>
                    ${sourceLinkHTML}
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-xs text-gray-500">Added: ${dateString}</p>
                        ${usedTagHTML}
                    </div>
                </div>
                <button class="delete-btn text-red-500 hover:text-red-700 font-bold text-xl flex-shrink-0">&times;</button>
            `;
            card.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                const itemToUpdate = contentItems.find(i => i.id == item.id);
                itemToUpdate.selected = e.target.checked;
                saveToLocalStorage();
            });
            card.querySelector('.delete-btn').addEventListener('click', () => {
                contentItems = contentItems.filter(i => i.id !== item.id);
                saveToLocalStorage();
                renderGallery();
            });
            card.querySelector('.used-toggle-btn').addEventListener('click', () => {
                const itemToUpdate = contentItems.find(i => i.id == item.id);
                itemToUpdate.used = !itemToUpdate.used;
                saveToLocalStorage();
                renderGallery();
            });
            return card;
        }

        function handleAddItem(data) {
            contentItems.push({ 
                id: itemIdCounter, 
                imageUrl: data.imageUrl, 
                caption: data.caption, 
                sourceUrl: data.sourceUrl, 
                selected: true,
                used: false,
                createdAt: Date.now()
            });
            itemIdCounter++;
            saveToLocalStorage();
            renderGallery();
        }

        function handleGenerate() {
            const selectedItems = contentItems.filter(item => item.selected);
            quill.setContents([]);
            sourcesOutput.value = '';
            sourcesContainer.classList.add('hidden');

            if (selectedItems.length === 0) {
                quill.setText('No items selected. Please check the boxes next to the items you want to include in your post.');
                return;
            }

            let sourcesToDisplay = [];
            
            selectedItems.forEach((item, index) => {
                const number = index + 1;
                const captionText = `${number}. ${item.caption}\n`;
                
                quill.insertText(quill.getLength() - 1, captionText);
                quill.insertEmbed(quill.getLength() - 1, 'image', item.imageUrl);
                quill.insertText(quill.getLength() - 1, '-\n');

                if (item.sourceUrl) {
                    sourcesToDisplay.push(item.sourceUrl);
                }
                const itemInDb = contentItems.find(dbItem => dbItem.id === item.id);
                if (itemInDb) {
                    itemInDb.used = true;
                }
            });

            if (sourcesToDisplay.length > 0) {
                let sourcesText = "Sources:\n";
                sourcesToDisplay.forEach((url, index) => {
                    sourcesText += `${index + 1}. ${url}\n`;
                });
                sourcesOutput.value = sourcesText.trim();
                sourcesContainer.classList.remove('hidden');
            }
            saveToLocalStorage();
            renderGallery();
        }

        function handleCopy() {
            const editor = document.querySelector('#output-editor .ql-editor');
            if (!editor || editor.textContent.trim() === '') {
                alert('Please generate a post first.');
                return;
            }
            const range = document.createRange();
            range.selectNodeContents(editor);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                if (document.execCommand('copy')) {
                    copyFeedback.textContent = 'Copied successfully!';
                    copyFeedback.classList.remove('hidden');
                    setTimeout(() => copyFeedback.classList.add('hidden'), 2500);
                } else { throw new Error('Copy command failed'); }
            } catch (err) {
                console.error('Copy failed', err);
                alert('Could not copy the post.');
            }
            selection.removeAllRanges();
        }
        
        function handleCopySources() {
            if (sourcesOutput.value.trim() === '') {
                alert('No sources to copy.');
                return;
            }
            sourcesOutput.select();
            try {
                if (document.execCommand('copy')) {
                    copyFeedback.textContent = 'Sources copied successfully!';
                    copyFeedback.classList.remove('hidden');
                    setTimeout(() => copyFeedback.classList.add('hidden'), 2500);
                } else { throw new Error('Copy command failed'); }
            } catch (err) {
                 console.error('Copy failed', err);
                alert('Could not copy sources.');
            }
        }

        // --- Image Input Handling ---
        function handleImageFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                alert('Please drop or paste an image file.');
                return;
            }
            addItemBtn.disabled = true;
            uploadStatus.textContent = 'Uploading image...';
            uploadStatus.classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = async (event) => {
                const base64String = event.target.result.split(',')[1];
                const formData = new FormData();
                formData.append('image', base64String);
                try {
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error('ImgBB API Error:', errorBody);
                        throw new Error(`Image upload failed with status: ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.success) {
                        imageUrlInput.value = result.data.url;
                        uploadStatus.textContent = 'Upload complete!';
                        setTimeout(() => uploadStatus.classList.add('hidden'), 2000);
                    } else { throw new Error('Image hosting service returned an error.'); }
                } catch (error) {
                    console.error("Image upload error:", error);
                    alert("Failed to upload image. Please try again or use a URL.");
                    uploadStatus.classList.add('hidden');
                } finally {
                    addItemBtn.disabled = false;
                }
            };
            reader.onerror = (error) => {
                console.error("File reading error:", error);
                alert("Failed to read the image file.");
                addItemBtn.disabled = false;
                uploadStatus.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // --- Reddit Fetcher ---
        async function fetchRedditPost() {
            let url = redditUrlInput.value.trim();
            if (!url) { alert('Please enter a Reddit post URL.'); return; }
            if (url.endsWith('/')) { url = url.slice(0, -1); }
            if (!url.endsWith('.json')) { url += '.json'; }
            fetchRedditBtn.disabled = true;
            redditFetchStatus.textContent = 'Fetching post...';
            redditFetchStatus.classList.remove('hidden');
            try {
                const response = await fetch(url);
                if (!response.ok) { throw new Error(`Failed to fetch Reddit post. Status: ${response.status}`); }
                const data = await response.json();
                const postData = data[0]?.data?.children[0]?.data;
                if (!postData) { throw new Error('Could not find post data in the response.'); }
                if (postData.post_hint !== 'image') { throw new Error('The linked post does not appear to be a direct image post.'); }
                const imageUrl = postData.url_overridden_by_dest || postData.url;
                const caption = postData.title;
                const source = `https://www.reddit.com${postData.permalink}`;
                handleAddItem({ imageUrl, caption, sourceUrl: source });
                redditFetchStatus.textContent = 'Post fetched and added to gallery!';
                setTimeout(() => redditFetchStatus.classList.add('hidden'), 3000);
                redditUrlInput.value = '';
            } catch (error) {
                console.error("Reddit fetch error:", error);
                alert(`Failed to fetch Reddit post: ${error.message}`);
                redditFetchStatus.classList.add('hidden');
            } finally {
                fetchRedditBtn.disabled = false;
            }
        }

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleImageFile(e.dataTransfer.files[0]);
        });
        dropZone.addEventListener('paste', (e) => {
            if (e.clipboardData.files.length) {
                e.preventDefault();
                handleImageFile(e.clipboardData.files[0]);
            }
        });

        // --- Drag and Drop for Gallery ---
        let draggedItem = null;
        gallery.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('card')) {
                draggedItem = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            }
        });
        gallery.addEventListener('dragend', () => { 
            if(draggedItem) {
                draggedItem.classList.remove('dragging'); 
                draggedItem = null;
                const newOrderIds = [...gallery.querySelectorAll('.card')].map(card => parseInt(card.dataset.id));
                contentItems.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
                saveToLocalStorage();
            }
        });
        gallery.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(gallery, e.clientY);
            if (document.querySelector('.dragging')) gallery.insertBefore(document.querySelector('.dragging'), afterElement);
        });
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- Export/Import Data ---
        exportBtn.addEventListener('click', () => {
            if (contentItems.length === 0) { alert('No content to export.'); return; }
            const dataStr = JSON.stringify({ items: contentItems, counter: itemIdCounter }, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = 'quora-content.json';
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        });
        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (Array.isArray(imported.items) && typeof imported.counter === 'number') {
                        contentItems = imported.items;
                        itemIdCounter = imported.counter;
                        saveToLocalStorage();
                        renderGallery();
                    } else { throw new Error('Invalid file format.'); }
                } catch (err) {
                    alert('Failed to import file. Make sure it is a valid JSON file exported from this tool.');
                    console.error(err);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });
        
        // --- Filter Logic ---
        filterContainer.addEventListener('click', (e) => {
            if (e.target.matches('.filter-btn')) {
                filterContainer.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                renderGallery();
            }
        });

        // --- Initial Setup ---
        addItemBtn.addEventListener('click', () => {
             const imageUrl = imageUrlInput.value.trim();
            const caption = captionInput.value.trim();
            const sourceUrl = sourceUrlInput.value.trim();
            if (!imageUrl || !caption) {
                alert('Please provide at least an image and a caption.');
                return;
            }
            handleAddItem({imageUrl, caption, sourceUrl});
            imageUrlInput.value = '';
            captionInput.value = '';
            sourceUrlInput.value = '';
        });
        generateBtn.addEventListener('click', handleGenerate);
        copyBtn.addEventListener('click', handleCopy);
        copySourcesBtn.addEventListener('click', handleCopySources);
        fetchRedditBtn.addEventListener('click', fetchRedditPost);
        
        // --- Load data from Local Storage on start ---
        loadFromLocalStorage();

    </script>
</body>
</html>
